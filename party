-- ==================== AUTO PARTY MODULE ====================
-- Load t·ª´: https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/autoparty.lua
-- Y√™u c·∫ßu: WindUI, c√°c bi·∫øn global t·ª´ file ch√≠nhd
-- ===========================================================

local Module = {}

-- ‚úÖ L·∫•y c√°c bi·∫øn c·∫ßn thi·∫øt t·ª´ file ch√≠nh
local WindUI = _G.WindUI
local Window = _G.Window
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local a6 = _G.TeleportService
local aC = _G.CurrentDungeon
local ay = _G.CurrentDungeonId
local az = _G.CurrentDifficulty
local ce = _G.DungeonsList
local cc = _G.WorldsList
local ToggleStates = _G.ToggleStates
local Toggles = _G.Toggles
local ConfigSystem = _G.ConfigSystem

-- ==================== GLOBALS ====================
local PartyGlobals = {
    PartySetup = { Leader = "", Members = {"", "", "", "", ""} },
    isMonitoringParty = false,
    isLoadingPartyConfig = false,
    isInitializingUI = true,
    globalInviteCooldown = {},
    GLOBAL_INVITE_COOLDOWN = 30,
    PartyConfigFile = "AnyaHub_PartyConfig_" .. c.Name .. ".txt"
}

local SharedJobIdSystem = {
    CurrentJobId = nil,
    LastUpdateTime = 0,
    UpdateInterval = 5,
    FilePath = d .. '_SharedJobId.txt',
    InDungeon = false,
    LastDungeonInfo = nil,
    
    WorldJobIdCache = {},
    LastScanTime = 0,
    ScanInterval = 300,
    IsScanning = false,
    
    -- ‚úÖ CH·ªà GI·ªÆ L·∫†I WORLD 1
    ValidWorlds = {
        {PlaceId = 4310463616, Name = 'World 1'}
    }
}

-- ==================== SHARED JOB ID SYSTEM ====================
function SharedJobIdSystem:GetRequestFunction()
    return (syn and syn.request) or 
           (http and http.request) or 
           (http_request) or 
           (fluxus and fluxus.request) or
           request
end

function SharedJobIdSystem:ScanPlaceJobIds(placeId, maxServers)
    maxServers = maxServers or 5
    local requestFunc = self:GetRequestFunction()
    
    if not requestFunc then
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ HTTP request")
        return {}
    end
    
    local jobIds = {}
    local cursor = nil
    local scanned = 0
    
    pcall(function()
        repeat
            local url = string.format(
                "https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100%s",
                placeId,
                cursor and ("&cursor=" .. cursor) or ""
            )
            
            local response = requestFunc({Url = url, Method = "GET"})
            
            if response and response.Body then
                local data = e:JSONDecode(response.Body)
                
                if data and data.data then
                    for _, server in ipairs(data.data) do
                        if server.playing < server.maxPlayers - 2 then
                            table.insert(jobIds, {
                                JobId = server.id,
                                Players = server.playing,
                                MaxPlayers = server.maxPlayers
                            })
                            scanned = scanned + 1
                            
                            if scanned >= maxServers then
                                break
                            end
                        end
                    end
                end
                
                cursor = data.nextPageCursor
            else
                break
            end
            
            task.wait(0.5)
        until not cursor or scanned >= maxServers
    end)
    
    return jobIds
end

function SharedJobIdSystem:ScanAllWorlds()
    if self.IsScanning then
        warn("‚ö†Ô∏è ƒêang scan, b·ªè qua")
        return
    end
    
    self.IsScanning = true
    warn("üîç B·∫Øt ƒë·∫ßu scan JobId World 1...")
    
    task.spawn(function()
        for _, world in ipairs(self.ValidWorlds) do
            pcall(function()
                warn("üì° Scanning", world.Name, "...")
                
                local jobIds = self:ScanPlaceJobIds(world.PlaceId, 3)
                
                if #jobIds > 0 then
                    self.WorldJobIdCache[world.PlaceId] = {
                        Name = world.Name,
                        JobIds = jobIds,
                        LastUpdate = tick()
                    }
                    warn("‚úÖ", world.Name, "- T√¨m th·∫•y", #jobIds, "servers")
                else
                    warn("‚ö†Ô∏è", world.Name, "- Kh√¥ng t√¨m th·∫•y server ph√π h·ª£p")
                end
                
                task.wait(1)
            end)
        end
        
        self.LastScanTime = tick()
        self.IsScanning = false
        warn("‚úÖ Scan ho√†n t·∫•t!")
        
        self:SaveJobIdCache()
    end)
end

function SharedJobIdSystem:SaveJobIdCache()
    if not writefile then return end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    pcall(function()
        local data = {
            Cache = self.WorldJobIdCache,
            LastScanTime = self.LastScanTime
        }
        writefile(cacheFile, e:JSONEncode(data))
        warn("üíæ ƒê√£ l∆∞u JobId cache")
    end)
end

function SharedJobIdSystem:LoadJobIdCache()
    if not (readfile and isfile) then return false end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    if not isfile(cacheFile) then return false end
    
    local success = pcall(function()
        local content = readfile(cacheFile)
        local data = e:JSONDecode(content)
        
        if data then
            self.WorldJobIdCache = data.Cache or {}
            self.LastScanTime = data.LastScanTime or 0
            
            if tick() - self.LastScanTime > 1800 then
                warn("‚ö†Ô∏è Cache qu√° c≈©")
                return false
            end
            
            warn("üìÇ Loaded JobId cache - Age:", math.floor(tick() - self.LastScanTime), "gi√¢y")
            return true
        end
    end)
    
    return success
end

function SharedJobIdSystem:GetWorld1JobId()
    local world1PlaceId = 4310463616
    local data = self.WorldJobIdCache[world1PlaceId]
    
    if data and data.JobIds and #data.JobIds > 0 then
        local randomJobId = data.JobIds[math.random(1, #data.JobIds)]
        
        return {
            PlaceId = world1PlaceId,
            Name = "World 1",
            JobId = randomJobId.JobId,
            Players = randomJobId.Players
        }
    end
    
    warn("‚ùå Kh√¥ng c√≥ World 1 trong cache")
    return nil
end

function SharedJobIdSystem:SaveJobId(jobId, dungeonInfo)
    if not writefile then return end
    
    local data = {
        JobId = jobId,
        Timestamp = tick(),
        PlaceId = game.PlaceId,
        DungeonInfo = dungeonInfo or self.LastDungeonInfo
    }
    
    pcall(function()
        writefile(self.FilePath, e:JSONEncode(data))
        warn("üíæ ƒê√£ l∆∞u JobId:", jobId)
    end)
end

function SharedJobIdSystem:LoadJobId()
    if not (readfile and isfile and isfile(self.FilePath)) then 
        return nil 
    end
    
    local success, result = pcall(function()
        local content = readfile(self.FilePath)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 900 then
            return nil
        end
        
        return data
    end)
    
    return success and result or nil
end

function SharedJobIdSystem:ClearJobId()
    if not writefile then return end
    pcall(function()
        writefile(self.FilePath, "")
    end)
end

function SharedJobIdSystem:GetCurrentJobId()
    return game.JobId
end

function SharedJobIdSystem:GetCurrentDungeonInfo()
    if not aC then return nil end
    
    for _, dungeonData in ipairs(ce) do
        if dungeonData.Id == ay then
            return {
                Id = dungeonData.Id,
                Name = dungeonData.Name,
                Difficulty = az,
                Code = dungeonData.Code
            }
        end
    end
    
    return nil
end

function SharedJobIdSystem:UpdateJobId()
    local currentJobId = self:GetCurrentJobId()
    
    if aC then
        self.InDungeon = true
        self.LastDungeonInfo = self:GetCurrentDungeonInfo()
        
        if Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value then
            local timeSinceLastScan = tick() - self.LastScanTime
            
            if timeSinceLastScan >= self.ScanInterval and not self.IsScanning then
                self:ScanAllWorlds()
            end
        end
    end
    
    if currentJobId ~= self.CurrentJobId then
        self.CurrentJobId = currentJobId
        self.LastUpdateTime = tick()
        self:SaveJobId(currentJobId, self.LastDungeonInfo)
    end
end

function SharedJobIdSystem:StartMonitoring()
    self:LoadJobIdCache()
    
    task.spawn(function()
        while task.wait(self.UpdateInterval) do
            pcall(function()
                self:UpdateJobId()
            end)
        end
    end)
end

function SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
    if not targetJobId or targetJobId == "" then
        return false
    end
    
    pcall(function()
        a6:TeleportToPlaceInstance(targetPlaceId, targetJobId, c)
    end)
    
    return true
end

-- ==================== PARTY FUNCTIONS ====================
local function timeElapsed(seconds)
    local mins = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%dm %ds", mins, secs)
end

local function getPlayersList()
    local players = {}
    for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
        table.insert(players, player.Name)
    end
    table.sort(players)
    return players
end

local function isLeader() 
    return PartyGlobals.PartySetup.Leader == c.Name 
end

local function getMyPartyId()
    local success, partyId = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then 
            return nil 
        end
        
        for _, party in ipairs(Parties:GetChildren()) do
            local Members = party:FindFirstChild("Members")
            if Members then
                for _, memberFolder in ipairs(Members:GetChildren()) do
                    if memberFolder.Name == c.Name then
                        return party.Name
                    end
                end
            end
        end
        
        return nil
    end)
    
    return success and partyId or nil
end

local function isInParty(playerName)
    local partyId = getMyPartyId()
    if not partyId then 
        return false 
    end
    
    local success, result = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then 
            return false 
        end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then 
            return false 
        end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then 
            return false 
        end
        
        return Members:FindFirstChild(playerName) ~= nil
    end)
    
    return success and result or false
end

local function getCurrentPartyMemberCount()
    local partyId = getMyPartyId()
    if not partyId then return 0 end
    
    local success, count = pcall(function()
        local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
        if not Parties then return 0 end
        
        local myParty = Parties:FindFirstChild(partyId)
        if not myParty then return 0 end
        
        local Members = myParty:FindFirstChild("Members")
        if not Members then return 0 end
        
        return #Members:GetChildren()
    end)
    
    return success and count or 0
end

local function inviteMember(playerName)
    local currentTime = tick()
    local lastInvited = PartyGlobals.globalInviteCooldown[playerName] or 0
    local timeSinceInvite = currentTime - lastInvited
    
    if timeSinceInvite < PartyGlobals.GLOBAL_INVITE_COOLDOWN then
        warn("‚è≥ Invite cooldown active for", playerName)
        return
    end
    
    pcall(function()
        local player = game:GetService("Players"):FindFirstChild(playerName)
        if player then
            game:GetService("ReplicatedStorage").Shared.Party.Invite:FireServer(player)
            PartyGlobals.globalInviteCooldown[playerName] = currentTime
            warn("üì§ Sent Invite to:", playerName)
            WindUI:Notify({
                Title = "Party Invite",
                Content = "üì§ Invited " .. playerName,
                Duration = 2
            })
        end
    end)
end

-- ‚úÖ S·ª¨A L·∫†I ACCEPT INVITE THEO Y√äU C·∫¶U
local function acceptInvite(fromPlayer)
    pcall(function()
        local args = {
            [1] = game:GetService("Players"):WaitForChild(fromPlayer)
        }
        
        game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Party"):WaitForChild("AcceptedInvite"):FireServer(unpack(args))
        
        warn("‚úÖ Accepted invite from:", fromPlayer)
        WindUI:Notify({
            Title = "Party Invite",
            Content = "‚úÖ Accepted from " .. fromPlayer,
            Duration = 2
        })
    end)
end

local function getMembersToInvite()
    local toInvite = {}
    for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
        if memberName ~= "" and memberName ~= c.Name then
            table.insert(toInvite, memberName)
        end
    end
    return toInvite
end

local function getMissingMembers()
    local missing = {}
    for _, memberName in ipairs(getMembersToInvite()) do
        if not isInParty(memberName) then
            table.insert(missing, memberName)
        end
    end
    return missing
end

-- ‚úÖ S·ª¨A L·∫†I PARTY MONITORING - C·∫¢ LEADER V√Ä MEMBER ƒê·ªÄU REJOIN
local function startPartyMonitoring()
    if PartyGlobals.isMonitoringParty then 
        warn("‚ö†Ô∏è Party monitoring already active")
        return 
    end
    
    PartyGlobals.isMonitoringParty = true
    warn("‚úÖ Started party monitoring")
    
    if aC then
        warn("üîç ƒêang trong dungeon - Trigger scan JobId...")
        SharedJobIdSystem:ScanAllWorlds()
    end
    
    local rejoinAttempts = 0
    local lastRejoinTime = 0
    
    task.spawn(function()
        while Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value do
            -- ‚úÖ KI·ªÇM TRA CHO C·∫¢ LEADER V√Ä MEMBER
            local membersToCheck = getMembersToInvite()
            local currentCount = getCurrentPartyMemberCount()
            local expectedTotal = #membersToCheck + 1
            
            if currentCount >= expectedTotal then
                warn("‚úÖ Party ƒë√£ ƒë·ªß", expectedTotal, "ng∆∞·ªùi!")
                rejoinAttempts = 0
            else
                warn("‚ö†Ô∏è Party thi·∫øu", expectedTotal - currentCount, "ng∆∞·ªùi")
                
                local missingMembers = getMissingMembers()
                local onlineMissingCount = 0
                
                for _, memberName in ipairs(missingMembers) do
                    if game:GetService("Players"):FindFirstChild(memberName) then
                        onlineMissingCount = onlineMissingCount + 1
                    end
                end
                
                -- ‚úÖ N·∫æU C√ì NG∆Ø·ªúI THI·∫æU V√Ä ONLINE ‚Üí C·∫¢ LEADER V√Ä MEMBER ƒê·ªÄU REJOIN
                if onlineMissingCount > 0 then
                    local timeSinceLastRejoin = tick() - lastRejoinTime
                    
                    if timeSinceLastRejoin >= 90 and rejoinAttempts < 5 then
                        warn("üîÑ Ph√°t hi·ªán party thi·∫øu ng∆∞·ªùi ‚Üí C·∫¢ LEADER V√Ä MEMBER ƒë·ªÅu rejoin v·ªÅ World 1")
                        rejoinAttempts = rejoinAttempts + 1
                        lastRejoinTime = tick()
                        
                        -- ‚úÖ L·∫§Y WORLD 1 JOBID T·ª™ CACHE
                        local world1Server = SharedJobIdSystem:GetWorld1JobId()
                        
                        if world1Server then
                            warn("üé≤ Rejoin v·ªÅ: World 1 - JobId:", world1Server.JobId)
                            
                            if isLeader() then
                                WindUI:Notify({
                                    Title = "Gathering Party",
                                    Content = "üîÑ Leader rejoin v·ªÅ World 1...\nJobId: " .. world1Server.JobId:sub(1, 20),
                                    Duration = 5
                                })
                            else
                                WindUI:Notify({
                                    Title = "Gathering Party",
                                    Content = "üîÑ Member rejoin v·ªÅ World 1...\nJobId: " .. world1Server.JobId:sub(1, 20),
                                    Duration = 5
                                })
                            end
                            
                            task.wait(2)
                            -- ‚úÖ REJOIN V·ªÄ C√ôNG PLACEID V√Ä JOBID
                            SharedJobIdSystem:TeleportToPlace(world1Server.PlaceId, world1Server.JobId)
                            return
                        else
                            warn("‚ùå Kh√¥ng c√≥ World 1 JobId trong cache - Trigger scan")
                            SharedJobIdSystem:ScanAllWorlds()
                        end
                    else
                        -- M·ªùi l·∫°i n·∫øu ch∆∞a ƒë·∫øn l√∫c rejoin
                        if isLeader() then
                            warn("üîµ Leader ƒëang m·ªùi l·∫°i members...")
                            for _, memberName in ipairs(missingMembers) do
                                if game:GetService("Players"):FindFirstChild(memberName) then
                                    inviteMember(memberName)
                                    task.wait(2)
                                end
                            end
                        end
                    end
                end
            end
            
            task.wait(10)
        end
        PartyGlobals.isMonitoringParty = false
    end)
end

-- ==================== CONFIG FUNCTIONS ====================
local function savePartyConfig()
    if not writefile or PartyGlobals.isLoadingPartyConfig then return end
    
    local data = {
        Leader = PartyGlobals.PartySetup.Leader,
        Members = PartyGlobals.PartySetup.Members
    }
    writefile(PartyGlobals.PartyConfigFile, e:JSONEncode(data))
    warn("üíæ Saved party config")
end

local function loadPartyConfig()
    if not isfile or not isfile(PartyGlobals.PartyConfigFile) then 
        return false 
    end
    
    PartyGlobals.isLoadingPartyConfig = true
    
    local success = pcall(function()
        local content = readfile(PartyGlobals.PartyConfigFile)
        local data = e:JSONDecode(content)
        
        if data then
            PartyGlobals.PartySetup.Leader = data.Leader or ""
            for i = 1, 5 do
                PartyGlobals.PartySetup.Members[i] = (data.Members and data.Members[i]) or ""
            end
            
            warn("üìÇ Loaded party config")
            
            task.delay(0.1, function()
                PartyGlobals.isLoadingPartyConfig = false
            end)
            
            return true
        end
    end)
    
    if not success then
        PartyGlobals.isLoadingPartyConfig = false
    end
    
    return success
end

-- ==================== UI CREATION ====================
local function createRejoinSystemUI(TabParty)
    TabParty:Divider({ Text = "üîÑ Auto Rejoin System" })
    
    local jobIdPara = TabParty:Paragraph({ 
        Title = "üìç Current JobId", 
        Description = "Loading..." 
    })
    
    local rejoinStatusPara = TabParty:Paragraph({ 
        Title = "üîÑ Rejoin Status", 
        Description = "Disabled" 
    })
    
    task.spawn(function()
        while task.wait(2) do
            pcall(function()
                local currentJobId = SharedJobIdSystem:GetCurrentJobId()
                local savedData = SharedJobIdSystem:LoadJobId()
                
                local desc = "Current: " .. (currentJobId and currentJobId:sub(1, 25) .. "..." or "None")
                
                if savedData and savedData.JobId then
                    local age = math.floor(tick() - savedData.Timestamp)
                    desc = desc .. "\n\nSaved JobId:"
                    desc = desc .. "\n  " .. savedData.JobId:sub(1, 25) .. "..."
                    desc = desc .. "\n  Age: " .. timeElapsed(age)
                    
                    if savedData.DungeonInfo then
                        desc = desc .. "\n  Dungeon: " .. savedData.DungeonInfo.Name
                    end
                end
                
                jobIdPara:SetDesc(desc)
            end)
        end
    end)
    
    ConfigSystem.registerUIElement("AutoRejoin", TabParty:Toggle({ 
        Title = "Auto Rejoin on Disconnect", 
        Description = "T·ª± ƒë·ªông rejoin + reform party", 
        Default = ToggleStates.AutoRejoin or false,
        Callback = function(s) 
            if Toggles.AutoRejoin then
                Toggles.AutoRejoin:SetValue(s)
            end
            
            if s then
                rejoinStatusPara:SetDesc("‚úÖ Enabled")
            else
                rejoinStatusPara:SetDesc("‚ùå Disabled")
            end
        end 
    }))
    
    TabParty:Button({
        Title = "üóëÔ∏è Clear Saved JobId",
        Description = "X√≥a JobId ƒë√£ l∆∞u",
        Callback = function()
            SharedJobIdSystem:ClearJobId()
            WindUI:Notify({
                Title = "JobId",
                Content = "üóëÔ∏è ƒê√£ x√≥a JobId",
                Duration = 2
            })
        end
    })
end

local function createAutoPartyTab()
    local TabParty = Window:Tab({
        Title = "Auto Party",
        Icon = "users",
        Locked = false,
    })
    
    -- ‚úÖ ƒêƒÉng k√Ω global
    _G.loadPartyConfigGlobal = loadPartyConfig
    _G.PartySetup = PartyGlobals.PartySetup
    
    local rolePara = TabParty:Paragraph({ 
        Title = "üé≠ My Role", 
        Description = "Not configured" 
    })
    
    local statusPara = TabParty:Paragraph({ 
        Title = "Current Party", 
        Description = "Not configured" 
    })
    
    local function updateStatus()
        local roleText = ""
        if PartyGlobals.PartySetup.Leader == c.Name then
            roleText = "üëë LEADER"
        elseif PartyGlobals.PartySetup.Leader ~= "" then
            roleText = "üë§ MEMBER\nLeader: " .. PartyGlobals.PartySetup.Leader
        else
            roleText = "‚ö†Ô∏è Not configured"
        end
        rolePara:SetDesc(roleText)
        
        local s = ""
        if PartyGlobals.PartySetup.Leader ~= "" then 
            local leaderInGame = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
            local isYou = PartyGlobals.PartySetup.Leader == c.Name and " (You)" or ""
            s = s .. (leaderInGame and "‚úÖ" or "‚ùå") .. " Leader: " .. PartyGlobals.PartySetup.Leader .. isYou .. "\n" 
        end
        
        for i, m in ipairs(PartyGlobals.PartySetup.Members) do 
            if m ~= "" then 
                local memberInGame = game:GetService("Players"):FindFirstChild(m)
                local inPartyStatus = isInParty(m) and "üü¢" or "‚ö™"
                local isYou = m == c.Name and " (You)" or ""
                s = s .. (memberInGame and "‚úÖ" or "‚ùå") .. inPartyStatus .. " M" .. i .. ": " .. m .. isYou .. "\n" 
            end 
        end
        
        local currentCount = getCurrentPartyMemberCount()
        if currentCount > 0 then
            s = s .. "\nüìä Party: " .. currentCount .. " members"
        end
        
        statusPara:SetDesc(s ~= "" and s or "Not configured")
    end
    
    _G.updatePartyStatus = updateStatus
    
    TabParty:Divider({ Text = "Party Setup" })
    
    TabParty:Dropdown({ 
        Title = "Party Leader", 
        Description = "Ch·ªçn t√™n player l√†m leader", 
        Values = getPlayersList(), 
        Multi = false, 
        Callback = function(v) 
            if PartyGlobals.isInitializingUI then return end
            
            PartyGlobals.PartySetup.Leader = v or ""
            updateStatus()
            savePartyConfig()
        end 
    })
    
    for i = 1, 5 do 
        TabParty:Dropdown({ 
            Title = "Member " .. i, 
            Description = "Ch·ªçn t√™n player", 
            Values = getPlayersList(), 
            Multi = false, 
            Callback = function(v) 
                if PartyGlobals.isInitializingUI then return end
                
                PartyGlobals.PartySetup.Members[i] = v or ""
                updateStatus()
                savePartyConfig()
            end 
        })
    end
    
    task.spawn(function()
        task.wait(1)
        local loaded = loadPartyConfig()
        task.wait(0.5)
        PartyGlobals.isInitializingUI = false
        
        if loaded then
            updateStatus()
            WindUI:Notify({
                Title = "Party Config",
                Content = "‚úÖ Loaded - " .. (isLeader() and "üëë Leader" or "üë§ Member"),
                Duration = 3
            })
        end
    end)
    
    TabParty:Divider({ Text = "Actions" })
    
    TabParty:Button({ 
        Title = "Refresh Status", 
        Description = "C·∫≠p nh·∫≠t status", 
        Callback = function() 
            updateStatus()
            WindUI:Notify({ Title = "Success", Content = "Refreshed!", Duration = 2 }) 
        end 
    })
    
    TabParty:Button({ 
        Title = "Save Party Config", 
        Description = "L∆∞u party setup", 
        Callback = function() 
            savePartyConfig()
            WindUI:Notify({ Title = "Success", Content = "‚úÖ ƒê√£ l∆∞u!", Duration = 3 })
        end 
    })
    
    TabParty:Divider({ Text = "Automation" })
    
    ConfigSystem.registerUIElement("AutoInviteAll", TabParty:Toggle({ 
        Title = "Auto Invite All", 
        Description = "T·ª± ƒë·ªông m·ªùi members (Leader only)",
        Default = ToggleStates.AutoInviteAll or false,
        Callback = function(s) 
            if Toggles.AutoInviteAll then
                Toggles.AutoInviteAll:SetValue(s)
            end
            
            if s then
                if not isLeader() then
                    WindUI:Notify({
                        Title = "Warning",
                        Content = "‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader!",
                        Duration = 3
                    })
                end
                
                task.spawn(function() 
                    while Toggles.AutoInviteAll and Toggles.AutoInviteAll.Value do
                        if isLeader() then
                            local membersToInvite = getMembersToInvite()
                            
                            for _, n in ipairs(membersToInvite) do 
                                if not isInParty(n) then
                                    inviteMember(n)
                                    task.wait(3)
                                end
                            end
                        end
                        
                        task.wait(25)
                    end 
                end) 
            end 
        end 
    }))
    
    createRejoinSystemUI(TabParty)
    
    TabParty:Divider({ Text = "Party Control" })
    
    -- ‚úÖ AUTO ACCEPT INVITE - V√íNG L·∫∂P LI√äN T·ª§C
    ConfigSystem.registerUIElement("AutoAcceptInvite", TabParty:Toggle({ 
        Title = "Auto Accept Invite", 
        Description = "T·ª± ƒë·ªông accept invite t·ª´ leader (Member only)", 
        Default = ToggleStates.AutoAcceptInvite or false,
        Callback = function(s) 
            if Toggles.AutoAcceptInvite then
                Toggles.AutoAcceptInvite:SetValue(s)
            end
            
            if s then
                if isLeader() then
                    WindUI:Notify({
                        Title = "Warning",
                        Content = "‚ö†Ô∏è B·∫°n l√† leader!",
                        Duration = 3
                    })
                end
                
                -- ‚úÖ V√íNG L·∫∂P LI√äN T·ª§C ACCEPT INVITE
                task.spawn(function()
                    while Toggles.AutoAcceptInvite and Toggles.AutoAcceptInvite.Value do
                        if not isLeader() then
                            pcall(function()
                                local leaderPlayer = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
                                
                                if leaderPlayer then
                                    local currentPartyId = getMyPartyId()
                                    
                                    if not currentPartyId then
                                        warn("üì® ƒêang th·ª≠ accept invite t·ª´:", PartyGlobals.PartySetup.Leader)
                                        acceptInvite(PartyGlobals.PartySetup.Leader)
                                        
                                        task.wait(2)
                                        
                                        local newPartyId = getMyPartyId()
                                        if newPartyId then
                                            WindUI:Notify({
                                                Title = "Party",
                                                Content = "‚úÖ ƒê√£ v√†o party v·ªõi " .. PartyGlobals.PartySetup.Leader,
                                                Duration = 3
                                            })
                                            warn("‚úÖ ƒê√£ v√†o party th√†nh c√¥ng!")
                                        end
                                    end
                                else
                                    warn("‚ö†Ô∏è Leader", PartyGlobals.PartySetup.Leader, "kh√¥ng online")
                                end
                            end)
                        end
                        
                        task.wait(3)
                    end
                    
                    warn("‚ùå Auto Accept Invite ƒë√£ t·∫Øt")
                end)
            end
        end 
    }))
    
    ConfigSystem.registerUIElement("AutoPartyMonitor", TabParty:Toggle({ 
        Title = "Auto Monitor Party", 
        Description = "C·∫¢ LEADER V√Ä MEMBER ƒë·ªÅu rejoin v·ªÅ World 1 (c√πng JobId) khi thi·∫øu ng∆∞·ªùi", 
        Default = ToggleStates.AutoPartyMonitor or false,
        Callback = function(s) 
            if Toggles.AutoPartyMonitor then
                Toggles.AutoPartyMonitor:SetValue(s)
            end
            
            if s then 
                startPartyMonitoring() 
            end 
        end 
    }))
    
    task.spawn(function() 
        while task.wait(3) do 
            updateStatus() 
        end 
    end)
end

-- ==================== INIT MODULE ====================
function Module:Init()
    SharedJobIdSystem:StartMonitoring()
    createAutoPartyTab()
    warn("‚úÖ Auto Party Module loaded!")
end

return Module
