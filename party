-- ============== DI CHUY·ªÇN SHAREDJOBIDSYSTEM RA NGO√ÄI (TR∆Ø·ªöC createAutoPartyTab) ==============
-- ƒê·∫∂T ·ªû D√íNG ~7205 (NGO√ÄI M·ªåI H√ÄM)

-- ‚úÖ GLOBAL SCOPE - TR√ÅNH L·ªñI "Out of local registers"
local PartyGlobals = {
    PartySetup = { Leader = "", Members = {"", "", "", "", ""} },
    isMonitoringParty = false,
    isLoadingPartyConfig = false,
    isInitializingUI = true,
    globalInviteCooldown = {},
    GLOBAL_INVITE_COOLDOWN = 30,
    PartyConfigFile = "AnyaHub_PartyConfig_" .. c.Name .. ".txt"
}

local SharedJobIdSystem = {
    CurrentJobId = nil,
    LastUpdateTime = 0,
    UpdateInterval = 5,
    FilePath = d .. '_SharedJobId.txt',
    InDungeon = false,
    LastDungeonInfo = nil,
    
    WorldJobIdCache = {},
    LastScanTime = 0,
    ScanInterval = 300,
    IsScanning = false,
    
    ValidWorlds = {
        {PlaceId = 4310463616, Name = 'World 1'},
        {PlaceId = 4310463940, Name = 'World 2'},
        {PlaceId = 4465987684, Name = 'World 3'},
        {PlaceId = 4646472003, Name = 'World 4'},
        {PlaceId = 5703355191, Name = 'World 5'},
        {PlaceId = 6075083204, Name = 'World 6'},
        {PlaceId = 6847035264, Name = 'World 7'},
        {PlaceId = 9944262922, Name = 'World 8'},
        {PlaceId = 10651517727, Name = 'World 9'},
        {PlaceId = 14914684761, Name = 'World 10'},
        {PlaceId = 6510868181, Name = 'PvpArena'},
        {PlaceId = 7499964980, Name = 'Marketplace'},
    }
}

function SharedJobIdSystem:GetRequestFunction()
    return (syn and syn.request) or 
           (http and http.request) or 
           (http_request) or 
           (fluxus and fluxus.request) or
           request
end

function SharedJobIdSystem:ScanPlaceJobIds(placeId, maxServers)
    maxServers = maxServers or 5
    local requestFunc = self:GetRequestFunction()
    
    if not requestFunc then
        warn("‚ùå Executor kh√¥ng h·ªó tr·ª£ HTTP request")
        return {}
    end
    
    local jobIds = {}
    local cursor = nil
    local scanned = 0
    
    pcall(function()
        repeat
            local url = string.format(
                "https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100%s",
                placeId,
                cursor and ("&cursor=" .. cursor) or ""
            )
            
            local response = requestFunc({Url = url, Method = "GET"})
            
            if response and response.Body then
                local data = e:JSONDecode(response.Body)
                
                if data and data.data then
                    for _, server in ipairs(data.data) do
                        if server.playing < server.maxPlayers - 2 then
                            table.insert(jobIds, {
                                JobId = server.id,
                                Players = server.playing,
                                MaxPlayers = server.maxPlayers
                            })
                            scanned = scanned + 1
                            
                            if scanned >= maxServers then
                                break
                            end
                        end
                    end
                end
                
                cursor = data.nextPageCursor
            else
                break
            end
            
            task.wait(0.5)
        until not cursor or scanned >= maxServers
    end)
    
    return jobIds
end

function SharedJobIdSystem:ScanAllWorlds()
    if self.IsScanning then
        warn("‚ö†Ô∏è ƒêang scan, b·ªè qua")
        return
    end
    
    self.IsScanning = true
    warn("üîç B·∫Øt ƒë·∫ßu scan JobId c·ªßa t·∫•t c·∫£ World...")
    
    task.spawn(function()
        for _, world in ipairs(self.ValidWorlds) do
            pcall(function()
                warn("üì° Scanning", world.Name, "...")
                
                local jobIds = self:ScanPlaceJobIds(world.PlaceId, 3)
                
                if #jobIds > 0 then
                    self.WorldJobIdCache[world.PlaceId] = {
                        Name = world.Name,
                        JobIds = jobIds,
                        LastUpdate = tick()
                    }
                    warn("‚úÖ", world.Name, "- T√¨m th·∫•y", #jobIds, "servers")
                else
                    warn("‚ö†Ô∏è", world.Name, "- Kh√¥ng t√¨m th·∫•y server ph√π h·ª£p")
                end
                
                task.wait(1)
            end)
        end
        
        self.LastScanTime = tick()
        self.IsScanning = false
        warn("‚úÖ Scan ho√†n t·∫•t!")
        
        self:SaveJobIdCache()
    end)
end

function SharedJobIdSystem:SaveJobIdCache()
    if not writefile then return end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    pcall(function()
        local data = {
            Cache = self.WorldJobIdCache,
            LastScanTime = self.LastScanTime
        }
        writefile(cacheFile, e:JSONEncode(data))
        warn("üíæ ƒê√£ l∆∞u JobId cache")
    end)
end

function SharedJobIdSystem:LoadJobIdCache()
    if not (readfile and isfile) then return false end
    
    local cacheFile = d .. '_WorldJobIdCache.txt'
    
    if not isfile(cacheFile) then return false end
    
    local success = pcall(function()
        local content = readfile(cacheFile)
        local data = e:JSONDecode(content)
        
        if data then
            self.WorldJobIdCache = data.Cache or {}
            self.LastScanTime = data.LastScanTime or 0
            
            if tick() - self.LastScanTime > 1800 then
                warn("‚ö†Ô∏è Cache qu√° c≈©")
                return false
            end
            
            warn("üìÇ Loaded JobId cache - Age:", math.floor(tick() - self.LastScanTime), "gi√¢y")
            return true
        end
    end)
    
    return success
end

function SharedJobIdSystem:GetRandomCachedJobId()
    local availableWorlds = {}
    
    for placeId, data in pairs(self.WorldJobIdCache) do
        if data.JobIds and #data.JobIds > 0 then
            table.insert(availableWorlds, {
                PlaceId = placeId,
                Name = data.Name,
                JobIds = data.JobIds
            })
        end
    end
    
    if #availableWorlds == 0 then
        warn("‚ùå Kh√¥ng c√≥ World n√†o trong cache")
        return nil
    end
    
    local randomWorld = availableWorlds[math.random(1, #availableWorlds)]
    local randomJobId = randomWorld.JobIds[math.random(1, #randomWorld.JobIds)]
    
    return {
        PlaceId = randomWorld.PlaceId,
        Name = randomWorld.Name,
        JobId = randomJobId.JobId,
        Players = randomJobId.Players
    }
end

function SharedJobIdSystem:SaveJobId(jobId, dungeonInfo)
    if not writefile then return end
    
    local data = {
        JobId = jobId,
        Timestamp = tick(),
        PlaceId = game.PlaceId,
        DungeonInfo = dungeonInfo or self.LastDungeonInfo
    }
    
    pcall(function()
        writefile(self.FilePath, e:JSONEncode(data))
        warn("üíæ ƒê√£ l∆∞u JobId:", jobId)
    end)
end

function SharedJobIdSystem:LoadJobId()
    if not (readfile and isfile and isfile(self.FilePath)) then 
        return nil 
    end
    
    local success, result = pcall(function()
        local content = readfile(self.FilePath)
        local data = e:JSONDecode(content)
        
        local timeDiff = tick() - (data.Timestamp or 0)
        if timeDiff > 900 then
            return nil
        end
        
        return data
    end)
    
    return success and result or nil
end

function SharedJobIdSystem:ClearJobId()
    if not writefile then return end
    pcall(function()
        writefile(self.FilePath, "")
    end)
end

function SharedJobIdSystem:GetCurrentJobId()
    return game.JobId
end

function SharedJobIdSystem:GetCurrentDungeonInfo()
    if not aC then return nil end
    
    for _, dungeonData in ipairs(ce) do
        if dungeonData.Id == ay then
            return {
                Id = dungeonData.Id,
                Name = dungeonData.Name,
                Difficulty = az,
                Code = dungeonData.Code
            }
        end
    end
    
    return nil
end

function SharedJobIdSystem:UpdateJobId()
    local currentJobId = self:GetCurrentJobId()
    
    if aC then
        self.InDungeon = true
        self.LastDungeonInfo = self:GetCurrentDungeonInfo()
        
        if Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value then
            local timeSinceLastScan = tick() - self.LastScanTime
            
            if timeSinceLastScan >= self.ScanInterval and not self.IsScanning then
                self:ScanAllWorlds()
            end
        end
    end
    
    if currentJobId ~= self.CurrentJobId then
        self.CurrentJobId = currentJobId
        self.LastUpdateTime = tick()
        self:SaveJobId(currentJobId, self.LastDungeonInfo)
    end
end

function SharedJobIdSystem:StartMonitoring()
    self:LoadJobIdCache()
    
    task.spawn(function()
        while task.wait(self.UpdateInterval) do
            pcall(function()
                self:UpdateJobId()
            end)
        end
    end)
end

function SharedJobIdSystem:TeleportToPlace(targetPlaceId, targetJobId)
    if not targetJobId or targetJobId == "" then
        return false
    end
    
    pcall(function()
        a6:TeleportToPlaceInstance(targetPlaceId, targetJobId, c)
    end)
    
    return true
end

-- B·∫Øt ƒë·∫ßu monitoring
SharedJobIdSystem:StartMonitoring()

-- ============== SAU ƒê√ì M·ªöI ƒê·∫æN createRejoinSystemUI v√† createAutoPartyTab ==============
local function createRejoinSystemUI(TabParty, PartySetup)
    TabParty:Divider({ Text = "üîÑ Auto Rejoin System" })
    
    local jobIdPara = TabParty:Paragraph({ 
        Title = "üìç Current JobId", 
        Description = "Loading..." 
    })
    
    local rejoinStatusPara = TabParty:Paragraph({ 
        Title = "üîÑ Rejoin Status", 
        Description = "Disabled" 
    })
    
    -- Auto update JobId display
    task.spawn(function()
        while task.wait(2) do
            pcall(function()
                local currentJobId = SharedJobIdSystem:GetCurrentJobId()
                local savedData = SharedJobIdSystem:LoadJobId()
                
                local desc = "Current: " .. (currentJobId and currentJobId:sub(1, 25) .. "..." or "None")
                
                if savedData and savedData.JobId then
                    local age = math.floor(tick() - savedData.Timestamp)
                    desc = desc .. "\n\nSaved JobId:"
                    desc = desc .. "\n  " .. savedData.JobId:sub(1, 25) .. "..."
                    desc = desc .. "\n  Age: " .. timeElapsed(age)
                    desc = desc .. "\n  Place: " .. savedData.PlaceId
                    
                    if savedData.DungeonInfo then
                        desc = desc .. "\n  Dungeon: " .. savedData.DungeonInfo.Name
                    end
                end
                
                if AutoRejoinSystem.WaitingForParty then
                    desc = desc .. "\n\n‚è≥ ƒêang ch·ªù party reform..."
                elseif AutoRejoinSystem.IsRejoining then
                    desc = desc .. "\n\nüîÑ ƒêang rejoin..."
                end
                
                jobIdPara:SetDesc(desc)
            end)
        end
    end)
    ConfigSystem.registerUIElement("AutoRejoin", TabParty:Toggle({ 
        Title = "Auto Rejoin on Disconnect", 
        Description = "T·ª± ƒë·ªông rejoin + reform party + quay l·∫°i dungeon", 
        Default = ToggleStates.AutoRejoin,  -- ‚úÖ ƒê·ªåC T·ª™ STATE
        Callback = function(s) 
            Toggles.AutoRejoin:SetValue(s)  -- ‚úÖ TH√äM D√íNG N√ÄY
            
            if s then
                AutoRejoinSystem:Enable()
                rejoinStatusPara:SetDesc("‚úÖ Enabled\n\nN·∫øu disconnect:\n1. Rejoin v·ªÅ random world (c√πng JobId)\n2. Reform party\n3. Quay l·∫°i dungeon c≈©")
            else
                AutoRejoinSystem:Disable()
                rejoinStatusPara:SetDesc("‚ùå Disabled")
            end
        end 
    }))
    
    TabParty:Button({
        Title = "üóëÔ∏è Clear Saved JobId",
        Description = "X√≥a JobId ƒë√£ l∆∞u",
        Callback = function()
            SharedJobIdSystem:ClearJobId()
            WindUI:Notify({
                Title = "JobId",
                Content = "üóëÔ∏è ƒê√£ x√≥a JobId",
                Duration = 2
            })
        end
    })
    
    TabParty:Button({
        Title = "üîÑ Manual Rejoin to Saved Server",
        Description = "Rejoin th·ªß c√¥ng v·ªÅ server ƒë√£ l∆∞u (random world)",
        Callback = function()
            local savedData = SharedJobIdSystem:LoadJobId()
            
            if not savedData or not savedData.JobId then
                WindUI:Notify({
                    Title = "Error",
                    Content = "‚ùå Kh√¥ng c√≥ JobId ƒë√£ l∆∞u",
                    Duration = 3
                })
                return
            end
            
            local randomPlaceId = SharedJobIdSystem:GetRandomValidPlaceId()
            local placeName = "Unknown"
            
            for key, placeData in pairs(cc) do
                if placeData.Id == randomPlaceId then
                    placeName = placeData.Name
                    break
                end
            end
            
            WindUI:Notify({
                Title = "Rejoining",
                Content = "üîÑ Rejoin v·ªÅ " .. placeName .. "...",
                Duration = 3
            })
            
            task.wait(2)
            SharedJobIdSystem:TeleportToPlace(randomPlaceId, savedData.JobId)
        end
    })
end

local function createAutoPartyTab()
    local TabParty = Window:Tab({
        Title = "Auto Party",
        Icon = "users",
        Locked = false,
    })


    -- ‚úÖ H√†m l∆∞u party config - CH·ªà save khi user thay ƒë·ªïi
    local function savePartyConfig()
        if not writefile or PartyGlobals.isLoadingPartyConfig then return end
        
        local data = {
            Leader = PartyGlobals.PartySetup.Leader,
            Members = PartyGlobals.PartySetup.Members
        }
        writefile(PartyGlobals.PartyConfigFile, game:GetService("HttpService"):JSONEncode(data))
        print("üíæ Saved party config - Leader:", data.Leader)
        print("üíæ Members:", table.concat(data.Members, ", "))
    end

    -- ‚úÖ H√†m load party config
    local function loadPartyConfig()
        if not isfile or not isfile(PartyGlobals.PartyConfigFile) then 
            print("‚ö†Ô∏è Party config file not found")
            return false 
        end
        
        PartyGlobals.isLoadingPartyConfig = true
        
        local success = pcall(function()
            local content = readfile(PartyGlobals.PartyConfigFile)
            local data = game:GetService("HttpService"):JSONDecode(content)
            
            if data then
                PartyGlobals.PartySetup.Leader = data.Leader or ""
                for i = 1, 5 do
                    PartyGlobals.PartySetup.Members[i] = (data.Members and data.Members[i]) or ""
                end
                
                print("üìÇ Loaded party config - Leader:", data.Leader)
                print("üìÇ Members:", table.concat(data.Members or {}, ", "))
                
                task.delay(0.1, function()
                    pcall(function()
                        if updateStatusFunction then updateStatusFunction() end
                        task.delay(0.1, function()
                            PartyGlobals.isLoadingPartyConfig = false
                            print("‚úÖ Party config load complete")
                        end)
                    end)
                end)
                
                return true
            end
        end)
        
        if not success then
            PartyGlobals.isLoadingPartyConfig = false
        end
        
        return success
    end
    
    -- ‚úÖ QUAN TR·ªåNG: ƒêƒÉng k√Ω global function
    _G.loadPartyConfigGlobal = loadPartyConfig
    _G.PartySetup = PartyGlobals.PartySetup
    
    local function getPlayersList()
        local players = {}
        for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
            table.insert(players, player.Name)
        end
        table.sort(players)
        return players
    end
    
    local function isLeader() 
        return PartyGlobals.PartySetup.Leader == c.Name 
    end
    
    local function getMyPartyId()
        local success, partyId = pcall(function()
            local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
            if not Parties then 
                return nil 
            end
            
            for _, party in ipairs(Parties:GetChildren()) do
                local Members = party:FindFirstChild("Members")
                if Members then
                    for _, memberFolder in ipairs(Members:GetChildren()) do
                        if memberFolder.Name == c.Name then
                            return party.Name
                        end
                    end
                end
            end
            
            return nil
        end)
        
        return success and partyId or nil
    end
    
    local function isInParty(playerName)
        local partyId = getMyPartyId()
        if not partyId then 
            warn("‚ö†Ô∏è isInParty: No party ID found")
            return false 
        end
        
        local success, result = pcall(function()
            local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
            if not Parties then 
                warn("‚ö†Ô∏è isInParty: Parties folder not found")
                return false 
            end
            
            local myParty = Parties:FindFirstChild(partyId)
            if not myParty then 
                warn("‚ö†Ô∏è isInParty: My party not found:", partyId)
                return false 
            end
            
            local Members = myParty:FindFirstChild("Members")
            if not Members then 
                warn("‚ö†Ô∏è isInParty: Members folder not found")
                return false 
            end
            
            local isMember = Members:FindFirstChild(playerName) ~= nil
            warn("üîç isInParty check:", playerName, "‚Üí", isMember)
            
            return isMember
        end)
        
        if not success then
            warn("‚ùå isInParty error for", playerName .. ":", result)
            return false
        end
        
        return result or false
    end
    
    local function getCurrentPartyMemberCount()
        local partyId = getMyPartyId()
        if not partyId then return 0 end
        
        local success, count = pcall(function()
            local Parties = game:GetService("ReplicatedStorage"):FindFirstChild("Parties")
            if not Parties then return 0 end
            
            local myParty = Parties:FindFirstChild(partyId)
            if not myParty then return 0 end
            
            local Members = myParty:FindFirstChild("Members")
            if not Members then return 0 end
            
            return #Members:GetChildren()
        end)
        
        return success and count or 0
    end
    
    local function inviteMember(playerName)
        -- ‚úÖ CHECK GLOBAL COOLDOWN
        local currentTime = tick()
        local lastInvited = PartyGlobals.globalInviteCooldown[playerName] or 0
        local timeSinceInvite = currentTime - lastInvited
        
        if timeSinceInvite < PartyGlobals.GLOBAL_INVITE_COOLDOWN then
            warn("‚è≥ Invite cooldown active for", playerName, "- wait", 
                math.ceil(PartyGlobals.GLOBAL_INVITE_COOLDOWN - timeSinceInvite), "more seconds")
            return
        end
        
        pcall(function()
            local player = game:GetService("Players"):FindFirstChild(playerName)
            if player then
                game:GetService("ReplicatedStorage").Shared.Party.Invite:FireServer(player)
                PartyGlobals.globalInviteCooldown[playerName] = currentTime
                warn("üì§ Sent Invite to:", playerName, "| Next invite in 30s")
                WindUI:Notify({
                    Title = "Party Invite",
                    Content = "üì§ Invited " .. playerName,
                    Duration = 2
                })
            else
                warn("‚ùå Player not found in game:", playerName)
            end
        end)
    end
    local function acceptInvite(fromPlayer)
        pcall(function()
            local player = game:GetService("Players"):FindFirstChild(fromPlayer)
            if player then
                game:GetService("ReplicatedStorage").Shared.Party.AcceptedInvite:FireServer(player)
                warn("‚úÖ Accepted invite from:", fromPlayer)
                WindUI:Notify({
                    Title = "Party Invite",
                    Content = "‚úÖ Accepted from " .. fromPlayer,
                    Duration = 2
                })
            else
                warn("‚ùå Player not found:", fromPlayer)
            end
        end)
    end
    
    local function getMembersToInvite()
        local toInvite = {}
        for _, memberName in ipairs(PartyGlobals.PartySetup.Members) do
            if memberName ~= "" and memberName ~= c.Name then
                table.insert(toInvite, memberName)
            end
        end
        return toInvite
    end
    -- TH√äM V√ÄO SAU H√ÄM getMembersToInvite() (d√≤ng ~7564)

local function checkPartyIncomplete()
    if not isLeader() then return false end
    
    local membersToCheck = getMembersToInvite()
    local currentCount = getCurrentPartyMemberCount()
    local expectedTotal = #membersToCheck + 1
    
    return currentCount < expectedTotal
end

local function getMissingMembers()
    local missing = {}
    for _, memberName in ipairs(getMembersToInvite()) do
        if not isInParty(memberName) then
            table.insert(missing, memberName)
        end
    end
    return missing
end

-- H√ÄM M·ªöI: Auto rejoin to gather party
local function autoRejoinToGatherParty()
    if not isLeader() then
        warn("‚ùå Ch·ªâ leader m·ªõi c√≥ th·ªÉ rejoin to gather party")
        return
    end
    
    warn("üîÑ Checking party completeness...")
    
    local missingMembers = getMissingMembers()
    
    if #missingMembers == 0 then
        warn("‚úÖ Party ƒë√£ ƒë·ªß ng∆∞·ªùi!")
        return
    end
    
    warn("‚ö†Ô∏è Party thi·∫øu", #missingMembers, "ng∆∞·ªùi:", table.concat(missingMembers, ", "))
    
    -- Ki·ªÉm tra missing members c√≥ online kh√¥ng
    local onlineButNotInParty = {}
    local offlineMembers = {}
    
    for _, memberName in ipairs(missingMembers) do
        local player = game:GetService("Players"):FindFirstChild(memberName)
        if player then
            table.insert(onlineButNotInParty, memberName)
        else
            table.insert(offlineMembers, memberName)
        end
    end
    
    if #offlineMembers > 0 then
        warn("‚ùå Nh·ªØng ng∆∞·ªùi offline:", table.concat(offlineMembers, ", "))
        WindUI:Notify({
            Title = "Party Incomplete",
            Content = "‚ùå " .. table.concat(offlineMembers, ", ") .. " ƒëang offline!",
            Duration = 5
        })
    end
    
    if #onlineButNotInParty > 0 then
        warn("‚ö†Ô∏è Online nh∆∞ng ch∆∞a v√†o party:", table.concat(onlineButNotInParty, ", "))
        
        -- Load JobId
        local savedData = SharedJobIdSystem:LoadJobId()
        
        if not savedData or not savedData.JobId then
            warn("‚ùå Kh√¥ng c√≥ JobId ƒë·ªÉ rejoin")
            WindUI:Notify({
                Title = "Error",
                Content = "‚ùå Kh√¥ng c√≥ JobId ƒë·ªÉ rejoin!",
                Duration = 3
            })
            return
        end
        
        -- Random ch·ªçn world ƒë·ªÉ rejoin
        local randomPlaceId = SharedJobIdSystem:GetRandomValidPlaceId()
        local placeName = "Unknown"
        
        for key, placeData in pairs(cc) do
            if placeData.Id == randomPlaceId then
                placeName = placeData.Name
                break
            end
        end
        
        warn("üé≤ S·∫Ω rejoin v·ªÅ:", placeName, "- JobId:", savedData.JobId)
        
        WindUI:Notify({
            Title = "Gathering Party",
            Content = "üîÑ Rejoin v·ªÅ " .. placeName .. " ƒë·ªÉ m·ªùi l·∫°i team...",
            Duration = 5
        })
        
        task.wait(2)
        
        -- Rejoin v·ªÅ world kh√°c (c√πng JobId)
        SharedJobIdSystem:TeleportToPlace(randomPlaceId, savedData.JobId)
    else
        warn("‚úÖ T·∫•t c·∫£ members ƒë·ªÅu online, ch·ªâ c·∫ßn m·ªùi l·∫°i")
        
        -- M·ªùi l·∫°i
        for _, memberName in ipairs(missingMembers) do
            inviteMember(memberName)
            task.wait(2)
        end
    end
end

local function startPartyMonitoring()
    if PartyGlobals.isMonitoringParty then 
        warn("‚ö†Ô∏è Party monitoring already active")
        return 
    end
    
    PartyGlobals.isMonitoringParty = true
    warn("‚úÖ Started party monitoring")
    
    if aC then
        warn("üîç ƒêang trong dungeon - Trigger scan JobId...")
        SharedJobIdSystem:ScanAllWorlds()
    end
    
    local rejoinAttempts = 0
    local lastRejoinTime = 0
    
    task.spawn(function()
        while Toggles.AutoPartyMonitor and Toggles.AutoPartyMonitor.Value do
            if isLeader() then
                local membersToCheck = getMembersToInvite()
                local currentCount = getCurrentPartyMemberCount()
                local expectedTotal = #membersToCheck + 1
                
                warn("üìä Party Status - Members in party:", currentCount, "/", expectedTotal)
                
                if currentCount >= expectedTotal then
                    warn("‚úÖ‚úÖ Party ƒë√£ ƒë·ªß", expectedTotal, "ng∆∞·ªùi!")
                    rejoinAttempts = 0
                else
                    warn("‚ö†Ô∏è Party thi·∫øu", expectedTotal - currentCount, "ng∆∞·ªùi")
                    
                    local missingMembers = getMissingMembers()
                    local hasOnlineMissing = false
                    local onlineNames = {}
                    
                    for _, memberName in ipairs(missingMembers) do
                        if game:GetService("Players"):FindFirstChild(memberName) then
                            hasOnlineMissing = true
                            table.insert(onlineNames, memberName)
                        end
                    end
                    
                    if hasOnlineMissing then
                        warn("üü¢ C√≥ ng∆∞·ªùi online nh∆∞ng ch∆∞a v√†o party:", table.concat(onlineNames, ", "))
                        
                        for _, memberName in ipairs(onlineNames) do
                            inviteMember(memberName)
                            task.wait(2)
                        end
                        
                        task.wait(15)
                        currentCount = getCurrentPartyMemberCount()
                        
                        if currentCount < expectedTotal then
                            local timeSinceLastRejoin = tick() - lastRejoinTime
                            
                            if timeSinceLastRejoin >= 120 and rejoinAttempts < 3 then
                                warn("üîÑ M·ªùi kh√¥ng ƒë∆∞·ª£c ‚Üí Rejoin ƒë·ªÉ gather party")
                                rejoinAttempts = rejoinAttempts + 1
                                lastRejoinTime = tick()
                                
                                local cachedServer = SharedJobIdSystem:GetRandomCachedJobId()
                                
                                if cachedServer then
                                    warn("üé≤ Rejoin v·ªÅ:", cachedServer.Name)
                                    WindUI:Notify({
                                        Title = "Gathering Party",
                                        Content = "üîÑ Rejoin v·ªÅ " .. cachedServer.Name .. "...",
                                        Duration = 5
                                    })
                                    task.wait(2)
                                    SharedJobIdSystem:TeleportToPlace(cachedServer.PlaceId, cachedServer.JobId)
                                    return
                                else
                                    warn("‚ùå Kh√¥ng c√≥ cached JobId - th·ª≠ scan ngay")
                                    SharedJobIdSystem:ScanAllWorlds()
                                end
                            end
                        end
                    end
                end
            else
                warn("‚ö†Ô∏è Not leader, stopping monitoring")
                break
            end
            
            task.wait(10)
        end
        PartyGlobals.isMonitoringParty = false
        warn("‚ùå Stopped party monitoring")
    end)
end
    
    TabParty:Divider({ Text = "Party Setup" })
    
    local rolePara = TabParty:Paragraph({ 
        Title = "üé≠ My Role", 
        Description = "Not configured" 
    })
    
    local statusPara = TabParty:Paragraph({ 
        Title = "Current Party", 
        Description = "Not configured" 
    })
    
    -- ‚úÖ H√†m update status
    local function updateStatus()
        local roleText = ""
        if PartyGlobals.PartySetup.Leader == c.Name then
            roleText = "üëë LEADER"
        elseif PartyGlobals.PartySetup.Leader ~= "" then
            roleText = "üë§ MEMBER\nLeader: " .. PartyGlobals.PartySetup.Leader
        else
            roleText = "‚ö†Ô∏è Not configured"
        end
        rolePara:SetDesc(roleText)
        
        local s = ""
        if PartyGlobals.PartySetup.Leader ~= "" then 
            local leaderInGame = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
            local isYou = PartyGlobals.PartySetup.Leader == c.Name and " (You)" or ""
            s = s .. (leaderInGame and "‚úÖ" or "‚ùå") .. " Leader: " .. PartyGlobals.PartySetup.Leader .. isYou .. "\n" 
        end
        
        for i, m in ipairs(PartyGlobals.PartySetup.Members) do 
            if m ~= "" then 
                local memberInGame = game:GetService("Players"):FindFirstChild(m)
                local inPartyStatus = isInParty(m) and "üü¢" or "‚ö™"
                local isYou = m == c.Name and " (You)" or ""
                s = s .. (memberInGame and "‚úÖ" or "‚ùå") .. inPartyStatus .. " M" .. i .. ": " .. m .. isYou .. "\n" 
            end 
        end
        
        local currentCount = getCurrentPartyMemberCount()
        if currentCount > 0 then
            s = s .. "\nüìä Party: " .. currentCount .. " members"
        end
        
        statusPara:SetDesc(s ~= "" and s or "Not configured")
    end
    
    -- ‚úÖ L∆∞u global ƒë·ªÉ loadPartyConfig c√≥ th·ªÉ g·ªçi
    updateStatusFunction = updateStatus

    -- ‚úÖ Dropdown Leader
    TabParty:Dropdown({ 
        Title = "Party Leader", 
        Description = "Ch·ªçn t√™n player l√†m leader", 
        Values = getPlayersList(), 
        Multi = false, 
        Callback = function(v) 
            if PartyGlobals.isInitializingUI then 
                print("‚ö†Ô∏è Skipping save during UI init - Leader")
                return 
            end
            
            PartyGlobals.PartySetup.Leader = v or ""
            print("üîµ Party Leader:", v)
            updateStatus()
            savePartyConfig()
        end 
    })

    -- ‚úÖ Dropdown Members
    for i = 1, 5 do 
        TabParty:Dropdown({ 
            Title = "Member " .. i, 
            Description = "Ch·ªçn t√™n player", 
            Values = getPlayersList(), 
            Multi = false, 
            Callback = function(v) 
                if PartyGlobals.isInitializingUI then 
                    print("‚ö†Ô∏è Skipping save during UI init - Member " .. i)
                    return 
                end
                
                PartyGlobals.PartySetup.Members[i] = v or ""
                print("üîµ Member " .. i .. ":", v)
                updateStatus()
                savePartyConfig()
            end 
        })
    end

    -- ‚úÖ Load party config khi kh·ªüi ƒë·ªông
    task.spawn(function()
        task.wait(1)
        PartyGlobals.isLoadingPartyConfig = true
        local loaded = loadPartyConfig()
        task.wait(0.5)
        PartyGlobals.isLoadingPartyConfig = false
        PartyGlobals.isInitializingUI = false
        
        warn("‚úÖ UI initialization complete - save enabled for: " .. c.Name)
        
        if loaded then
            updateStatus()
            WindUI:Notify({
                Title = "Party Config",
                Content = "‚úÖ Loaded - " .. (isLeader() and "üëë Leader" or "üë§ Member"),
                Duration = 3
            })
        else
            warn("‚ö†Ô∏è No party config found for: " .. c.Name)
        end
    end)
    
    TabParty:Divider({ Text = "Actions" })
    
    TabParty:Button({ 
        Title = "Refresh Status", 
        Description = "C·∫≠p nh·∫≠t status", 
        Callback = function() 
            updateStatus()
            WindUI:Notify({ 
                Title = "Success", 
                Content = "Refreshed!", 
                Duration = 2 
            }) 
        end 
    })
    
    TabParty:Button({ 
        Title = "Save Party Config", 
        Description = "L∆∞u party setup hi·ªán t·∫°i", 
        Callback = function() 
            savePartyConfig()
            WindUI:Notify({
                Title = "Success",
                Content = "‚úÖ ƒê√£ l∆∞u party config!",
                Duration = 3
            })
        end 
    })
    
    TabParty:Button({ 
        Title = "Debug Party", 
        Description = "Xem th√¥ng tin party (F9)", 
        Callback = function() 
            print("=== PARTY DEBUG ===")
            print("My Name:", c.Name)
            print("My Role:", isLeader() and "LEADER" or "MEMBER")
            print("Party ID:", getMyPartyId() or "None")
            print("Member Count:", getCurrentPartyMemberCount())
            print("Configured Leader:", PartyGlobals.PartySetup.Leader)
            print("Configured Members:")
            for i, m in ipairs(PartyGlobals.PartySetup.Members) do
                if m ~= "" then
                    print("  " .. i .. ":", m, isInParty(m) and "(IN PARTY)" or "(NOT IN PARTY)")
                end
            end
            print("===================")
            WindUI:Notify({
                Title = "Debug",
                Content = "‚úÖ Check F9 console",
                Duration = 2
            })
        end 
    })
    
    TabParty:Divider({ Text = "Automation" })
    
    ConfigSystem.registerUIElement("AutoInviteAll", TabParty:Toggle({ 
        Title = "Auto Invite All", 
        Description = "T·ª± ƒë·ªông m·ªùi members",
        Default = ToggleStates.AutoInviteAll,  -- ‚úÖ ƒê√É C√ì TRONG CODE B·∫†N
        Callback = function(s) 
            Toggles.AutoInviteAll:SetValue(s) 
            
            if s then
                -- ‚úÖ CH·ªà C·∫¢NH B√ÅO, KH√îNG FORCE T·∫ÆT
                if not isLeader() then
                    warn("‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader nh∆∞ng v·∫´n b·∫≠t Auto Invite All")
                    WindUI:Notify({
                        Title = "Warning",
                        Content = "‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader, toggle n√†y s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!",
                        Duration = 3
                    })
                end
                
                task.spawn(function() 
                    while Toggles.AutoInviteAll and Toggles.AutoInviteAll.Value do
                        -- ‚úÖ KI·ªÇM TRA ROLE TRONG V√íNG L·∫∂P
                        if not isLeader() then
                            warn("‚ö†Ô∏è Kh√¥ng ph·∫£i leader, b·ªè qua invite")
                            task.wait(10)
                        else
                            local membersToInvite = getMembersToInvite()
                            
                            if #membersToInvite > 0 then
                                for _, n in ipairs(membersToInvite) do 
                                    if not isInParty(n) then
                                        inviteMember(n)
                                        task.wait(3)
                                    end
                                end
                            end
                            
                            task.wait(25)
                        end
                    end 
                end) 
            end 
        end 
    }))
createRejoinSystemUI(TabParty, PartyGlobals.PartySetup)
    
TabParty:Divider({ Text = "Party Control" }) 
-- S·ª¨A D√íNG 7998-8075 (Auto Accept Invite Toggle)
-- ============== C√ÅCH ƒê∆†N GI·∫¢N - S·ª¨A AUTO ACCEPT INVITE ==============
ConfigSystem.registerUIElement("AutoAcceptInvite", TabParty:Toggle({ 
    Title = "Auto Accept Invite", 
    Description = "T·ª± ƒë·ªông accept invite t·ª´ leader", 
    Default = ToggleStates.AutoAcceptInvite,
    Callback = function(s) 
        Toggles.AutoAcceptInvite:SetValue(s)
        
        if s then
            -- ‚úÖ CH·ªà C·∫¢NH B√ÅO, KH√îNG FORCE T·∫ÆT
            if isLeader() then
                warn("‚ö†Ô∏è B·∫°n l√† leader nh∆∞ng v·∫´n b·∫≠t Auto Accept Invite")
                WindUI:Notify({
                    Title = "Warning",
                    Content = "‚ö†Ô∏è B·∫°n l√† leader, toggle n√†y s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!",
                    Duration = 3
                })
                -- KH√îNG return, KH√îNG SetValue(false)
            end
            
            warn("‚úÖ Auto Accept Invite enabled - s·∫Ω accept invite t·ª´:", PartyGlobals.PartySetup.Leader)
            
            task.spawn(function()
                while Toggles.AutoAcceptInvite.Value do
                    -- ‚úÖ KI·ªÇM TRA ROLE TRONG V√íNG L·∫∂P
                    if isLeader() then
                        warn("‚ö†Ô∏è ƒêang l√† leader, b·ªè qua accept invite")
                        task.wait(5)
                    else
                        pcall(function()
                            local leaderPlayer = game:GetService("Players"):FindFirstChild(PartyGlobals.PartySetup.Leader)
                            
                            if leaderPlayer then
                                local currentPartyId = getMyPartyId()
                                
                                if not currentPartyId then
                                    warn("üì® ƒêang th·ª≠ accept invite t·ª´:", PartyGlobals.PartySetup.Leader)
                                    
                                    game:GetService("ReplicatedStorage")
                                        :WaitForChild("Shared")
                                        :WaitForChild("Party")
                                        :WaitForChild("AcceptedInvite")
                                        :FireServer(leaderPlayer)
                                    
                                    warn("‚úÖ ƒê√£ g·ª≠i accept invite ƒë·∫øn:", PartyGlobals.PartySetup.Leader)
                                    
                                    task.wait(2)
                                    
                                    local newPartyId = getMyPartyId()
                                    if newPartyId then
                                        WindUI:Notify({
                                            Title = "Party",
                                            Content = "‚úÖ ƒê√£ v√†o party v·ªõi " .. PartyGlobals.PartySetup.Leader,
                                            Duration = 3
                                        })
                                        warn("‚úÖ‚úÖ ƒê√£ v√†o party th√†nh c√¥ng!")
                                    end
                                else
                                    warn("‚úì ƒê√£ trong party:", currentPartyId)
                                end
                            else
                                warn("‚ö†Ô∏è Leader", PartyGlobals.PartySetup.Leader, "kh√¥ng online")
                            end
                        end)
                        
                        task.wait(3)
                    end
                end
                
                warn("‚ùå Auto Accept Invite ƒë√£ t·∫Øt")
            end)
        end 
    end 
}))

-- ============== S·ª¨A AUTO PARTY MONITOR ==============
ConfigSystem.registerUIElement("AutoPartyMonitor", TabParty:Toggle({ 
    Title = "Auto Monitor Party", 
    Description = "T·ª± ƒë·ªông monitor party (ch·ªâ d√†nh cho leader)", 
    Default = ToggleStates.AutoPartyMonitor,
    Callback = function(s) 
        Toggles.AutoPartyMonitor:SetValue(s)
        
        if s then 
            -- ‚úÖ CH·ªà C·∫¢NH B√ÅO, KH√îNG FORCE T·∫ÆT
            if not isLeader() then
                warn("‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader nh∆∞ng v·∫´n b·∫≠t Auto Party Monitor")
                WindUI:Notify({
                    Title = "Warning",
                    Content = "‚ö†Ô∏è B·∫°n kh√¥ng ph·∫£i leader, toggle n√†y s·∫Ω kh√¥ng ho·∫°t ƒë·ªông!",
                    Duration = 3
                })
                -- KH√îNG return, KH√îNG SetValue(false)
            else
                startPartyMonitoring() 
            end
        end 
    end 
}))
task.spawn(function() 
    while task.wait(3) do 
        updateStatus() 
    end 
end)

    -- ‚úÖ CH·ªà D√ôNG EVENT LISTENER - X√ìA V√íNG L·∫∂P AUTO ACCEPT
    pcall(function() 
        game:GetService("ReplicatedStorage").Shared.Party.InvitedToParty.OnClientEvent:Connect(function(p) 
            if Toggles.AutoAcceptInvite and Toggles.AutoAcceptInvite.Value then
                if p.Name == PartyGlobals.PartySetup.Leader then
                    -- ‚úÖ KI·ªÇM TRA ƒê√É TRONG PARTY CH∆ØA
                    local partyId = getMyPartyId()
                    if partyId then
                        warn("‚ö†Ô∏è ƒê√£ trong party r·ªìi, kh√¥ng accept n·ªØa")
                        return
                    end
                    
                    task.wait(0.3) 
                    acceptInvite(p.Name)
                end
            end
        end) 
    end)
        

end

createAutoPartyTab()
